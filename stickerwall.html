<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ë¥¥Á∫∏Â¢ô</title>
  <style>
    body {
      font-family: "Microsoft YaHei", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      position: relative;
      min-height: 100vh;
      cursor: default;
    }
    .welcome-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .welcome-box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 400px;
    }
    .welcome-box h2 {
      margin-top: 0;
      color: #333;
    }
    .welcome-box input {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .welcome-box button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .welcome-box button:hover {
      background-color: #0056b3;
    }
    .controls {
      margin-bottom: 20px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .sticker {
      position: absolute;
      width: 250px;
      min-height: 200px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background-color: #fff9c4;
      cursor: move;
      user-select: none;
      font-size: 16px;
      line-height: 1.5;
      overflow: hidden;
    }
    .sticker-name {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .sticker-content {
      min-height: 40px;
      margin: 8px 0;
    }
    .sticker input {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .sticker button {
      padding: 4px 8px;
      font-size: 12px;
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <!-- Ê¨¢ËøéÊ®°ÊÄÅÊ°Ü -->
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-box">
      <h2>Ê¨¢ËøéÊù•Âà∞Ë¥¥Á∫∏Â¢ô</h2>
      <p>ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂßìÂêçÔºåÂºÄÂßãÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï</p>
      <input type="text" id="userNameInput" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó" maxlength="10" />
      <button id="startButton">Start Pasting</button>
    </div>
  </div>

  <!-- ÊéßÂà∂ÊåâÈíÆ -->
  <div class="controls">
    <button id="addSticker">Ê∑ªÂä†ÊàëÁöÑË¥¥Á∫∏</button>
    <button id="refresh">Âà∑Êñ∞Êü•ÁúãÂ§ßÂÆ∂ÁöÑÊÉ≥Ê≥ï</button>
  </div>

  <!-- ÂºïÂÖ• LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.22.0/dist/av-min.js"></script>

  <script>
    // ÂàùÂßãÂåñ LeanCloud
    AV.init({
      appId: "Gl2dY2QY6l7x82uiaEpRV1jH-gzGzoHsz",
      appKey: "Td5758pFasptUitMJ7s9H3ED",
      serverURL: "https://gl2dy2qy.lc-cn-n1-shared.com"
    });

    let currentUser = null;
    const COLORS = [
      '#FFF9C4', '#FFECB3', '#FFE0B2', '#FFCC80', 
      '#FFB74D', '#FFA726', '#FF9800', '#FB8C00', 
      '#F57C00', '#EF6C00'
    ];

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°å
    window.onload = function() {
      const userNameInput = document.getElementById('userNameInput');
      const startButton = document.getElementById('startButton');
      const addStickerBtn = document.getElementById('addSticker');
      const refreshBtn = document.getElementById('refresh');

      // Ëá™Âä®Â°´ÂÖÖÁî®Êà∑Âêç
      const savedName = localStorage.getItem('sticker_user_name');
      if (savedName) {
        userNameInput.value = savedName;
      }

      // ÁªëÂÆö‚ÄúÂºÄÂßãË¥¥Ë¥¥Á∫∏‚ÄùÊåâÈíÆ
      startButton.onclick = function() {
        const name = userNameInput.value.trim();
        if (!name) {
          alert("ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂßìÂêçÔºÅ");
          return;
        }
        currentUser = { id: 'user_' + Date.now(), name: name };
        localStorage.setItem('sticker_user_name', name);
        document.getElementById('welcomeModal').style.display = 'none';
        loadStickers(); // ËæìÂÖ•ÂßìÂêçÂêéÁ´ãÂç≥Âä†ËΩΩË¥¥Á∫∏
      };

      // Ê∑ªÂä†Êñ∞Ë¥¥Á∫∏
      addStickerBtn.onclick = () => {
        if (!currentUser) {
          alert("ËØ∑ÂÖàËæìÂÖ•ÂßìÂêçÔºÅ");
          document.getElementById('welcomeModal').style.display = 'flex';
          return;
        }

        const userColor = COLORS[currentUser.id.charCodeAt(0) % COLORS.length];
        const x = Math.random() * (window.innerWidth - 300) + 50;
        const y = Math.random() * (window.innerHeight - 250) + 100;

        const Sticker = AV.Object.extend('Sticker');
        const sticker = new Sticker();
        sticker.set('text', '');
        sticker.set('userId', currentUser.id);
        sticker.set('userName', currentUser.name);
        sticker.set('color', userColor);
        sticker.set('x', x);
        sticker.set('y', y);

        sticker.save().then(() => {
          loadStickers();
        }).catch(err => {
          console.error("‰øùÂ≠òË¥¥Á∫∏Â§±Ë¥•", err);
          alert("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú");
        });
      };

      // Âà∑Êñ∞Ë¥¥Á∫∏
      refreshBtn.onclick = loadStickers;
    };

    // Âä†ËΩΩË¥¥Á∫∏
    function loadStickers() {
      const query = new AV.Query('Sticker');
      query.descending('createdAt');
      query.find().then(stickers => {
        document.querySelectorAll('.sticker').forEach(el => el.remove());
        stickers.forEach(sticker => {
          createStickerElement(
            sticker.id,
            sticker.get('text'),
            sticker.get('userId'),
            sticker.get('userName'),
            sticker.get('x'),
            sticker.get('y'),
            sticker.get('color')
          );
        });
      }).catch(console.error);
    }

    // ÂàõÂª∫Ë¥¥Á∫∏ÂÖÉÁ¥†
    function createStickerElement(id, text, stickerUserId, stickerUserName, x, y, color) {
      const sticker = document.createElement('div');
      sticker.className = 'sticker';
      sticker.style.left = x + 'px';
      sticker.style.top = y + 'px';
      sticker.style.backgroundColor = color;

      const nameTag = document.createElement('div');
      nameTag.className = 'sticker-name';
      nameTag.textContent = `üìå ${stickerUserName}`;
      sticker.appendChild(nameTag);

      const content = document.createElement('div');
      content.className = 'sticker-content';
      content.textContent = text || 'ÂèåÂáªÁºñËæëÂÜÖÂÆπ...';
      sticker.appendChild(content);

      if (stickerUserId === currentUser?.id) {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = text || '';
        input.style.display = 'none';
        
        const saveBtn = document.createElement('button');
        saveBtn.textContent = '‰øùÂ≠ò';
        saveBtn.style.display = 'none';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Âà†Èô§';
        deleteBtn.style.display = 'none';
        deleteBtn.style.backgroundColor = '#dc3545';

        deleteBtn.onclick = () => {
          const avSticker = AV.Object.createWithoutData('Sticker', id);
          avSticker.destroy().then(() => {
            sticker.remove();
          }).catch(console.error);
        };

        saveBtn.onclick = () => {
          const newText = input.value.trim();
          const avSticker = AV.Object.createWithoutData('Sticker', id);
          avSticker.set('text', newText);
          avSticker.save().then(() => {
            input.style.display = 'none';
            saveBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            content.style.display = 'block';
            content.textContent = newText || 'ÂèåÂáªÁºñËæëÂÜÖÂÆπ...';
          }).catch(console.error);
        };

        content.ondblclick = () => {
          if (!currentUser) return;
          content.style.display = 'none';
          input.style.display = 'block';
          saveBtn.style.display = 'inline';
          deleteBtn.style.display = 'inline';
          input.focus();
        };

        sticker.appendChild(input);
        sticker.appendChild(saveBtn);
        sticker.appendChild(deleteBtn);
      }

      makeDraggable(sticker, id);
      document.body.appendChild(sticker);
    }

    // ‰ΩøË¥¥Á∫∏ÂèØÊãñÊãΩ
    function makeDraggable(element, docId) {
      let pos = { x: 0, y: 0 };
      element.onmousedown = (e) => {
        if (!currentUser) return;
        e.preventDefault();
        pos = { x: e.clientX - element.offsetLeft, y: e.clientY - element.offsetTop };
        document.onmousemove = dragMove;
        document.onmouseup = stopDrag;
      };

      function dragMove(e) {
        e.preventDefault();
        const newX = e.clientX - pos.x;
        const newY = e.clientY - pos.y;
        element.style.left = newX + 'px';
        element.style.top = newY + 'px';
      }

      function stopDrag() {
        document.onmouseup = null;
        document.onmousemove = null;
        const sticker = AV.Object.createWithoutData('Sticker', docId);
        sticker.set('x', parseInt(element.style.left));
        sticker.set('y', parseInt(element.style.top));
        sticker.save().catch(console.error);
      }
    }
  </script>
</body>
</html>
