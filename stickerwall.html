<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>共享贴纸墙</title>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 15px;
      position: relative;
      overflow-x: hidden;
      /* 允许选择文本 */
      user-select: auto; 
    }
    
    .welcome-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 15px;
    }
    
    .welcome-box {
      background: white;
      padding: 30px 25px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 500px;
      width: 100%;
    }
    
    .welcome-box h1 {
      color: #4a6fa5;
      margin-bottom: 15px;
      font-size: 24px;
    }
    
    .welcome-box p {
      color: #666;
      margin-bottom: 25px;
      line-height: 1.5;
      font-size: 16px;
    }
    
    .welcome-box input {
      width: 100%;
      padding: 15px;
      margin: 15px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .welcome-box input:focus {
      border-color: #4a6fa5;
      outline: none;
    }
    
    .welcome-box button {
      padding: 14px 30px;
      font-size: 16px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
    }
    
    .welcome-box button:hover {
      background-color: #3a5a80;
    }
    
    .controls {
      text-align: center;
      margin-bottom: 25px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .controls button {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 140px;
    }
    
    .controls button:hover {
      background-color: #3a5a80;
      transform: translateY(-2px);
    }
    
    /* 桌面版贴纸容器 - 实现网格布局 */
    #stickersContainer {
        display: grid;
        /* 响应式网格：最小宽度 250px 的贴纸，自动填充行 */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 20px; /* 贴纸之间的间距 */
        padding-top: 20px;
    }
    
    /* 桌面版贴纸样式 */
    .sticker {
      position: static; /* 禁用绝对定位，以便在网格布局中生效 */
      width: auto; /* 让网格控制宽度 */
      min-height: 180px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      /* 禁用拖拽时的光标，以强调不再自由移动 */
      cursor: default; 
      user-select: auto; /* 允许选择文本 */
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, box-shadow 0.2s;
      touch-action: auto;
    }
    
    .sticker:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    /* 移动版贴纸列表样式 */
    .sticker-list {
      display: none;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .sticker-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
      user-select: auto; /* 允许选择文本 */
    }
    
    .sticker-item:active {
      transform: scale(0.98);
    }
    
    .sticker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: bold;
      color: #555;
    }
    
    .sticker-content {
      flex: 1;
      min-height: 60px;
      margin: 10px 0;
      line-height: 1.5;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    
    .sticker-actions {
      display: none;
      margin-top: 10px;
    }
    
    .sticker.editing .sticker-actions,
    .sticker-item.editing .sticker-actions {
      display: block;
    }
    
    .sticker input,
    .sticker-item input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .sticker button,
    .sticker-item button {
      padding: 8px 12px;
      font-size: 14px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .sticker .save-btn,
    .sticker-item .save-btn {
      background-color: #4CAF50;
      color: white;
    }
    
    .sticker .cancel-btn,
    .sticker-item .cancel-btn {
      background-color: #f44336;
      color: white;
    }
    
    .sticker .delete-btn,
    .sticker-item .delete-btn {
      background-color: #ff5722;
      color: white;
    }
    
    .admin-delete {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background-color: rgba(211, 211, 211, 0.7);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.3s;
      z-index: 100;
      font-size: 24px;
      color: #666;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .admin-delete:hover {
      background-color: rgba(211, 211, 211, 0.9);
    }
    
    .password-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      padding: 15px;
    }
    
    .password-box {
      background: white;
      padding: 30px 25px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    
    .password-box h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 20px;
    }
    
    .password-box p {
      margin-bottom: 15px;
      color: #666;
    }
    
    .password-box input {
      width: 100%;
      padding: 15px;
      margin: 15px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    
    .password-box .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .password-box button {
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      flex: 1;
    }
    
    .password-box .confirm-btn {
      background-color: #f44336;
      color: white;
    }
    
    .password-box .cancel-btn {
      background-color: #9e9e9e;
      color: white;
    }
    
    .status {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }
    
    /* 移动端特定样式 */
    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      .controls button {
        width: 100%;
        max-width: 300px;
      }
      
      .sticker {
        display: none; /* 在移动设备上隐藏桌面版贴纸 */
      }
      
      .sticker-list {
        display: flex; /* 在移动设备上显示列表 */
      }
      
      .admin-delete {
        width: 60px;
        height: 60px;
        font-size: 28px;
      }
    }
    
    @media (min-width: 769px) {
      .sticker-list {
        display: none; /* 在桌面上隐藏列表 */
      }
      
      .sticker {
        display: flex; /* 在桌面上显示桌面版贴纸 */
      }
      /* 确保桌面网格容器在桌面设备上显示 */
      #stickersContainer {
        display: grid; 
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .welcome-box {
        padding: 25px 20px;
      }
      
      .welcome-box h1 {
        font-size: 22px;
      }
    }
    
    /* 长按提示 */
    .edit-hint {
      font-size: 12px;
      color: #888;
      font-weight: normal;
    }
    
    /* 移动端触摸反馈 */
    .sticker:active,
    .sticker-item:active {
      /* 移除活动时的缩放，因为它会干扰文本选择 */
      /* transform: scale(0.98); */
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    /* 用户颜色指示器 */
    .user-color-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-box">
      <h1>欢迎来到共享贴纸墙</h1>
      <p>在这里，你可以与其他人分享想法、笔记和灵感。<br>请输入你的姓名开始使用：</p>
      <input type="text" id="userNameInput" placeholder="请输入你的姓名" maxlength="15">
      <button id="startButton">开始使用</button>
    </div>
  </div>

  <div class="controls">
    <button id="addSticker">添加新贴纸</button>
    <button id="refreshStickers">刷新贴纸墙</button>
  </div>

  <div id="stickersContainer"></div>
  
  <div class="sticker-list" id="stickersList"></div>

  <div class="status" id="statusInfo">正在加载贴纸...</div>

  <div class="admin-delete" id="adminDelete">×</div>

  <div class="password-modal" id="passwordModal">
    <div class="password-box">
      <h3>管理员操作</h3>
      <p>请输入密码删除所有贴纸：</p>
      <input type="password" id="passwordInput" placeholder="请输入密码">
      <div class="button-group">
        <button class="cancel-btn" id="cancelDelete">取消</button>
        <button class="confirm-btn" id="confirmDelete">确认删除</button>
      </div>
    </div>
  </div>

  <script>
    // 初始化 LeanCloud
    AV.init({
      appId: "Gl2dY2QY6l7x82uiaEpRV1jH-gzGzoHsz",
      appKey: "Td5758pFasptUitMJ7s9H3ED",
      serverURL: "https://gl2dy2qy.lc-cn-n1-shared.com"
    });

    // 全局变量
    let currentUser = null;
    let stickers = [];
    const ADMIN_PASSWORD = "wang123";
    const COLORS = [
      '#FFB6C1', '#FFD700', '#98FB98', '#87CEEB', '#DDA0DD',
      '#F0E68C', '#E6E6FA', '#FFA07A', '#20B2AA', '#DEB887',
      '#FF69B4', '#BA55D3', '#9370DB', '#3CB371', '#00CED1'
    ];

    // DOM 元素
    const welcomeModal = document.getElementById('welcomeModal');
    const userNameInput = document.getElementById('userNameInput');
    const startButton = document.getElementById('startButton');
    const addStickerBtn = document.getElementById('addSticker');
    const refreshStickersBtn = document.getElementById('refreshStickers');
    const stickersContainer = document.getElementById('stickersContainer');
    const stickersList = document.getElementById('stickersList');
    const statusInfo = document.getElementById('statusInfo');
    const adminDeleteBtn = document.getElementById('adminDelete');
    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 检查本地存储中是否有用户名
      const savedUserName = localStorage.getItem('stickerUserName');
      if (savedUserName) {
        currentUser = {
          id: localStorage.getItem('stickerUserId') || 'user_' + Date.now(),
          name: savedUserName
        };
        welcomeModal.style.display = 'none';
        loadStickers();
      } else {
        welcomeModal.style.display = 'flex';
      }

      // 事件监听器
      startButton.addEventListener('click', startApp);
      addStickerBtn.addEventListener('click', addNewSticker);
      refreshStickersBtn.addEventListener('click', loadStickers);
      adminDeleteBtn.addEventListener('click', showPasswordModal);
      confirmDeleteBtn.addEventListener('click', deleteAllStickers);
      cancelDeleteBtn.addEventListener('click', hidePasswordModal);
      
      // 移动端：点击模态框外部关闭
      welcomeModal.addEventListener('click', function(e) {
        if (e.target === welcomeModal) {
          // 不允许点击外部关闭欢迎模态框
        }
      });
      
      passwordModal.addEventListener('click', function(e) {
        if (e.target === passwordModal) {
          hidePasswordModal();
        }
      });
    });

    // 开始应用
    function startApp() {
      const userName = userNameInput.value.trim();
      if (!userName) {
        alert('请输入你的姓名！');
        return;
      }
      
      currentUser = {
        id: 'user_' + Date.now(),
        name: userName
      };
      
      // 保存用户信息到本地存储
      localStorage.setItem('stickerUserName', userName);
      localStorage.setItem('stickerUserId', currentUser.id);
      
      welcomeModal.style.display = 'none';
      loadStickers();
    }

    // 加载贴纸
    function loadStickers() {
      statusInfo.textContent = '正在加载贴纸...';
      
      const query = new AV.Query('Sticker');
      // 默认按创建时间倒序排列，以保持有序性
      query.descending('createdAt'); 
      
      query.find().then(results => {
        stickersContainer.innerHTML = '';
        stickersList.innerHTML = '';
        stickers = [];
        
        if (results.length === 0) {
          statusInfo.textContent = '贴纸墙是空的，添加第一个贴纸吧！';
          return;
        }
        
        results.forEach(sticker => {
          const stickerData = {
            id: sticker.id,
            text: sticker.get('text') || '',
            userId: sticker.get('userId'),
            userName: sticker.get('userName'),
            // x, y 坐标在网格布局中不再使用
            x: sticker.get('x') || 0, 
            y: sticker.get('y') || 0,
            color: sticker.get('color') || '#FFD700'
          };
          
          stickers.push(stickerData);
          
          // 创建桌面版贴纸元素 (由 Grid 控制位置)
          createStickerElement(stickerData);
          
          // 创建移动版贴纸列表项
          createStickerListItem(stickerData);
        });
        
        statusInfo.textContent = `已加载 ${results.length} 个贴纸`;
      }).catch(error => {
        console.error('加载贴纸失败:', error);
        statusInfo.textContent = '加载贴纸失败，请刷新重试';
      });
    }

    // 创建桌面版贴纸元素
    function createStickerElement(stickerData) {
      const sticker = document.createElement('div');
      sticker.className = 'sticker';
      sticker.id = `sticker-${stickerData.id}`;
      // **移除位置设置，交由 CSS Grid 控制**
      // sticker.style.left = `${stickerData.x}px`;
      // sticker.style.top = `${stickerData.y}px`;
      sticker.style.backgroundColor = stickerData.color;
      
      // 贴纸头部 - 显示用户名
      const header = document.createElement('div');
      header.className = 'sticker-header';
      
      const colorIndicator = document.createElement('span');
      colorIndicator.className = 'user-color-indicator';
      colorIndicator.style.backgroundColor = stickerData.color;
      
      header.appendChild(colorIndicator);
      header.innerHTML += ` ${stickerData.userName}`;
      
      if (stickerData.userId === currentUser.id) {
        header.innerHTML += ' <span class="edit-hint">(双击编辑)</span>';
      }
      
      // 贴纸内容
      const content = document.createElement('div');
      content.className = 'sticker-content';
      content.textContent = stickerData.text || '双击编辑内容...';
      
      // 编辑区域（仅对贴纸所有者显示）
      const editArea = document.createElement('div');
      editArea.className = 'sticker-actions';
      
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.value = stickerData.text;
      textInput.placeholder = '输入贴纸内容...';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = '保存';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.textContent = '取消';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '删除';
      
      editArea.appendChild(textInput);
      editArea.appendChild(saveBtn);
      editArea.appendChild(cancelBtn);
      editArea.appendChild(deleteBtn);
      
      // 组装贴纸
      sticker.appendChild(header);
      sticker.appendChild(content);
      sticker.appendChild(editArea);
      
      // 添加到容器
      stickersContainer.appendChild(sticker);
      
      // 设置事件监听器
      setupStickerEvents(sticker, stickerData);
    }

    // 创建移动版贴纸列表项
    function createStickerListItem(stickerData) {
      const stickerItem = document.createElement('div');
      stickerItem.className = 'sticker-item';
      stickerItem.id = `sticker-item-${stickerData.id}`;
      stickerItem.style.borderLeft = `5px solid ${stickerData.color}`;
      
      // 贴纸头部 - 显示用户名
      const header = document.createElement('div');
      header.className = 'sticker-header';
      
      const colorIndicator = document.createElement('span');
      colorIndicator.className = 'user-color-indicator';
      colorIndicator.style.backgroundColor = stickerData.color;
      
      header.appendChild(colorIndicator);
      header.innerHTML += ` ${stickerData.userName}`;
      
      if (stickerData.userId === currentUser.id) {
        header.innerHTML += ' <span class="edit-hint">(点击编辑)</span>';
      }
      
      // 贴纸内容
      const content = document.createElement('div');
      content.className = 'sticker-content';
      content.textContent = stickerData.text || '点击编辑内容...';
      
      // 编辑区域（仅对贴纸所有者显示）
      const editArea = document.createElement('div');
      editArea.className = 'sticker-actions';
      
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.value = stickerData.text;
      textInput.placeholder = '输入贴纸内容...';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = '保存';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.textContent = '取消';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '删除';
      
      editArea.appendChild(textInput);
      editArea.appendChild(saveBtn);
      editArea.appendChild(cancelBtn);
      editArea.appendChild(deleteBtn);
      
      // 组装贴纸
      stickerItem.appendChild(header);
      stickerItem.appendChild(content);
      stickerItem.appendChild(editArea);
      
      // 添加到列表
      stickersList.appendChild(stickerItem);
      
      // 设置事件监听器
      setupStickerListItemEvents(stickerItem, stickerData);
    }

    // 设置桌面版贴纸事件
    function setupStickerEvents(stickerElement, stickerData) {
      const content = stickerElement.querySelector('.sticker-content');
      const editArea = stickerElement.querySelector('.sticker-actions');
      const textInput = stickerElement.querySelector('input');
      const saveBtn = stickerElement.querySelector('.save-btn');
      const cancelBtn = stickerElement.querySelector('.cancel-btn');
      const deleteBtn = stickerElement.querySelector('.delete-btn');
      
      // 只有贴纸所有者可以编辑
      if (stickerData.userId === currentUser.id) {
        // PC端：双击进入编辑模式
        content.addEventListener('dblclick', function() {
          stickerElement.classList.add('editing');
          textInput.focus();
        });
        
        // 保存编辑
        saveBtn.addEventListener('click', function() {
          const newText = textInput.value.trim();
          updateSticker(stickerData.id, newText);
          stickerElement.classList.remove('editing');
        });
        
        // 取消编辑
        cancelBtn.addEventListener('click', function() {
          stickerElement.classList.remove('editing');
          textInput.value = stickerData.text;
        });
        
        // 删除贴纸
        deleteBtn.addEventListener('click', function() {
          if (confirm('确定要删除这个贴纸吗？')) {
            deleteSticker(stickerData.id);
          }
        });
        
        // 按Enter保存
        textInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            saveBtn.click();
          }
        });
        
        // **移除拖拽功能的调用，以维持网格布局的有序性**
        // makeStickerDraggable(stickerElement, stickerData.id); 
      }
    }

    // 设置移动版贴纸列表项事件
    function setupStickerListItemEvents(stickerItem, stickerData) {
      const content = stickerItem.querySelector('.sticker-content');
      const editArea = stickerItem.querySelector('.sticker-actions');
      const textInput = stickerItem.querySelector('input');
      const saveBtn = stickerItem.querySelector('.save-btn');
      const cancelBtn = stickerItem.querySelector('.cancel-btn');
      const deleteBtn = stickerItem.querySelector('.delete-btn');
      
      // 只有贴纸所有者可以编辑
      if (stickerData.userId === currentUser.id) {
        // 移动端：点击进入编辑模式
        content.addEventListener('click', function() {
          // 如果已经是编辑模式，则不再次触发
          if (stickerItem.classList.contains('editing')) return;
          stickerItem.classList.add('editing');
          textInput.focus();
        });
        
        // 保存编辑
        saveBtn.addEventListener('click', function() {
          const newText = textInput.value.trim();
          updateSticker(stickerData.id, newText);
          stickerItem.classList.remove('editing');
        });
        
        // 取消编辑
        cancelBtn.addEventListener('click', function() {
          stickerItem.classList.remove('editing');
          textInput.value = stickerData.text;
        });
        
        // 删除贴纸
        deleteBtn.addEventListener('click', function() {
          if (confirm('确定要删除这个贴纸吗？')) {
            deleteSticker(stickerData.id);
          }
        });
        
        // 按Enter保存
        textInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            saveBtn.click();
          }
        });
      }
    }

    // 更新贴纸内容
    function updateSticker(stickerId, newText) {
      const sticker = AV.Object.createWithoutData('Sticker', stickerId);
      sticker.set('text', newText);
      
      sticker.save().then(() => {
        // 更新本地显示
        const content = document.querySelector(`#sticker-${stickerId} .sticker-content`);
        const listContent = document.querySelector(`#sticker-item-${stickerId} .sticker-content`);
        if (content) content.textContent = newText || '双击编辑内容...';
        if (listContent) listContent.textContent = newText || '点击编辑内容...';
        statusInfo.textContent = '贴纸已更新';
      }).catch(error => {
        console.error('更新贴纸失败:', error);
        alert('更新失败，请重试');
      });
    }

    // 删除单个贴纸
    function deleteSticker(stickerId) {
      const sticker = AV.Object.createWithoutData('Sticker', stickerId);
      
      sticker.destroy().then(() => {
        // 从DOM中移除
        const stickerElement = document.getElementById(`sticker-${stickerId}`);
        const stickerItem = document.getElementById(`sticker-item-${stickerId}`);
        if (stickerElement) stickerElement.remove();
        if (stickerItem) stickerItem.remove();
        statusInfo.textContent = '贴纸已删除';
      }).catch(error => {
        console.error('删除贴纸失败:', error);
        alert('删除失败，请重试');
      });
    }

    // 使贴纸可拖拽（桌面版） - **此功能已被禁用以保持网格布局的有序性**
    function makeStickerDraggable(stickerElement, stickerId) {
      // 拖拽功能被禁用
      /*
      let isDragging = false;
      let offsetX, offsetY;
      
      stickerElement.addEventListener('mousedown', startDrag);
      
      function startDrag(e) {
        if (stickerElement.classList.contains('editing')) return;
        
        isDragging = true;
        offsetX = e.clientX - stickerElement.offsetLeft;
        offsetY = e.clientY - stickerElement.offsetTop;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        e.preventDefault();
      }
      
      function drag(e) {
        if (!isDragging) return;
        
        const newX = e.clientX - offsetX;
        const newY = e.clientY - offsetY;
        
        const maxX = window.innerWidth - stickerElement.offsetWidth;
        const maxY = window.innerHeight - stickerElement.offsetHeight;
        
        stickerElement.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
        stickerElement.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
      }
      
      function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        
        // 拖拽保存功能也被禁用，以保持网格布局的有序性
        // const sticker = AV.Object.createWithoutData('Sticker', stickerId);
        // sticker.set('x', parseInt(stickerElement.style.left));
        // sticker.set('y', parseInt(stickerElement.style.top));
        // sticker.save().catch(console.error);
      }
      */
    }

    // 添加新贴纸
    function addNewSticker() {
      if (!currentUser) {
        alert('请先输入姓名！');
        welcomeModal.style.display = 'flex';
        return;
      }
      
      // 根据用户名生成颜色
      const colorIndex = currentUser.name.charCodeAt(0) % COLORS.length;
      const userColor = COLORS[colorIndex];
      
      // 随机位置（在网格布局中不再重要，但为避免旧数据错误仍需设置默认值）
      const x = 50 + Math.random() * 50; 
      const y = 100 + Math.random() * 50;
      
      const Sticker = AV.Object.extend('Sticker');
      const newSticker = new Sticker();
      
      newSticker.set('text', '');
      newSticker.set('userId', currentUser.id);
      newSticker.set('userName', currentUser.name);
      newSticker.set('color', userColor);
      newSticker.set('x', x); 
      newSticker.set('y', y);
      
      newSticker.save().then(() => {
        loadStickers(); // 重新加载所有贴纸
        statusInfo.textContent = '新贴纸已添加';
      }).catch(error => {
        console.error('添加贴纸失败:', error);
        alert('添加失败，请重试');
      });
    }

    // 显示密码模态框
    function showPasswordModal() {
      passwordModal.style.display = 'flex';
      passwordInput.focus();
    }

    // 隐藏密码模态框
    function hidePasswordModal() {
      passwordModal.style.display = 'none';
      passwordInput.value = '';
    }

    // 删除所有贴纸
    function deleteAllStickers() {
      const password = passwordInput.value.trim();
      if (password !== ADMIN_PASSWORD) {
        alert('密码错误！');
        return;
      }
      
      if (!confirm('确定要删除所有贴纸吗？此操作不可撤销！')) {
        return;
      }
      
      const query = new AV.Query('Sticker');
      query.find().then(results => {
        if (results.length === 0) {
          alert('没有可删除的贴纸');
          hidePasswordModal();
          return;
        }
        
        // 批量删除
        return AV.Object.destroyAll(results);
      }).then(() => {
        stickersContainer.innerHTML = '';
        stickersList.innerHTML = '';
        statusInfo.textContent = '所有贴纸已删除';
        hidePasswordModal();
      }).catch(error => {
        console.error('删除贴纸失败:', error);
        alert('删除失败，请重试');
      });
    }

    // 定期刷新贴纸（每30秒）
    setInterval(loadStickers, 30000);
  </script>
</body>
</html>
