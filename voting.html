<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Voting Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f8ff;
      padding: 30px;
      text-align: center;
    }
    button.vote-btn {
      display: block;
      margin: 10px auto;
      padding: 15px 30px;
      font-size: 18px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      color: green;
    }
    #results-container {
      margin-top: 30px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    #admin-buttons {
      position: fixed;
      bottom: 10px;
      right: 10px;
    }
    #admin-buttons button {
      font-size: 12px;
      padding: 5px 10px;
      margin-left: 5px;
      cursor: pointer;
    }

    /* Modal (password box) styles */
    #passwordModal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
    }
    #passwordModalContent {
      background: white;
      width: 300px;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      text-align: center;
    }
    #passwordModal input {
      padding: 8px;
      font-size: 16px;
      width: 80%;
      margin-top: 10px;
    }
    #passwordModal button {
      margin-top: 15px;
      padding: 8px 20px;
      cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Vote for Your Favorite Idea!</h1>

  <div id="vote-buttons"></div>

  <h2 id="status"></h2>

  <div id="results-container">
    <canvas id="voteChart"></canvas>
    <div id="resultsTable"></div>
  </div>

  <!-- Admin buttons -->
  <div id="admin-buttons">
    <button onclick="passwordProtected(resetVotes)">Reset Votes</button>
    <button onclick="passwordProtected(configureOptions)">Configure Options</button>
  </div>

  <!-- Password modal -->
  <div id="passwordModal">
    <div id="passwordModalContent">
      <h3>Enter Admin Password</h3>
      <form id="passwordForm" onsubmit="submitPassword(event)">
        <input type="password" id="adminPassword" name="password" autocomplete="current-password" placeholder="Password" required>
        <br>
        <button type="submit">Confirm</button>
        <button type="button" onclick="closePasswordModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const binId = "690b614cd0ea881f40d5b4f9"; 
    const apiKey = "$2a$10$mhQIaXkGG.V7HJDmwso9D.ChP8nEDgFE0Dke0VtnKJ5R7siCKvZHK";  

    let voteOptions = { "A": 1, "B": 0, "C": 0, "D": 0 }; 
    let chart = null;
    let pendingAction = null;

    async function loadVoteOptions() {
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
          headers: { "X-Master-Key": apiKey }
        });
        const data = await res.json();
        voteOptions = data.record;
        renderVoteButtons();
        showResults(voteOptions);
      } catch (err) {
        console.error("Failed to load options", err);
      }
    }

    function renderVoteButtons() {
      const container = document.getElementById("vote-buttons");
      container.innerHTML = '';
      for (const key in voteOptions) {
        const btn = document.createElement("button");
        btn.className = "vote-btn";
        btn.innerText = key;
        btn.onclick = () => vote(key);
        container.appendChild(btn);
      }
    }

    async function vote(choice) {
      if (localStorage.getItem("hasVoted")) {
        document.getElementById("status").innerText = "You can only vote once per reset!";
        return;
      }

      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
          headers: { "X-Master-Key": apiKey }
        });
        const data = await res.json();
        data.record[choice] += 1;

        await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": apiKey
          },
          body: JSON.stringify(data.record)
        });

        localStorage.setItem("hasVoted", "true");
        document.getElementById("status").innerText = `Thanks for voting for "${choice}"!`;
        voteOptions = data.record;
        showResults(voteOptions);
      } catch (err) {
        document.getElementById("status").innerText = "Error submitting your vote.";
        console.error(err);
      }
    }

    // Modal password system
    function passwordProtected(action) {
      pendingAction = action;
      document.getElementById("passwordModal").style.display = "block";
      document.getElementById("adminPassword").focus();
    }

    function closePasswordModal() {
      document.getElementById("passwordModal").style.display = "none";
      document.getElementById("adminPassword").value = "";
      pendingAction = null;
    }

    function submitPassword(event) {
      event.preventDefault();
      const password = document.getElementById("adminPassword").value;
      if (password === "wang123") {
        closePasswordModal();
        if (pendingAction) pendingAction();
      } else {
        alert("Incorrect password!");
      }
    }

    async function resetVotes() {
      if(!confirm("Are you sure you want to reset all votes?")) return;

      for (const key in voteOptions) voteOptions[key] = 0;

      try {
        await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": apiKey
          },
          body: JSON.stringify(voteOptions)
        });

        localStorage.removeItem("hasVoted");
        document.getElementById("status").innerText = "Votes have been reset!";
        showResults(voteOptions);
      } catch (err) {
        console.error("Failed to reset votes", err);
      }
    }

    function configureOptions() {
      const newOptionsStr = prompt("Enter vote options separated by ';' (e.g., Option1;Option2;Option3):", Object.keys(voteOptions).join(";"));
      if (!newOptionsStr) return;

      const newKeys = newOptionsStr.split(";").map(s => s.trim());
      const newVoteOptions = {};
      newKeys.forEach(key => newVoteOptions[key] = voteOptions[key] || 0);

      voteOptions = newVoteOptions;
      renderVoteButtons();

      fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": apiKey
        },
        body: JSON.stringify(voteOptions)
      }).then(() => showResults(voteOptions));
    }

    function showResults(record) {
      const labels = Object.keys(record);
      const values = Object.values(record);

      const ctx = document.getElementById('voteChart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40']
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = values.reduce((a,b)=>a+b,0);
                  const percent = total ? ((context.raw/total)*100).toFixed(1) : 0;
                  return `${context.label}: ${context.raw} votes (${percent}%)`;
                }
              }
            }
          }
        }
      });

      let tableHTML = "<table border='1' style='margin:auto'><tr><th>Option</th><th>Votes</th><th>Percentage</th></tr>";
      const totalVotes = values.reduce((a,b)=>a+b,0);
      labels.forEach((key,i)=>{
        const percent = totalVotes ? ((values[i]/totalVotes)*100).toFixed(1) : 0;
        tableHTML += `<tr><td>${key}</td><td>${values[i]}</td><td>${percent}%</td></tr>`;
      });
      tableHTML += "</table>";
      document.getElementById("resultsTable").innerHTML = tableHTML;
    }

    window.onload = loadVoteOptions;
  </script>
</body>
</html>
